<!--
SHP Import Application
Author: Adhiraj Datar
ver:1.0

Application for Dronedeploy market to import .shp and .zip files and
convert them into flight plans for the Dronedeploy platform.
-->

<html>

    <head>
        <meta charset="utf-8"/>
        <script src="js/shp.js"></script>  
        <script src="js/proj4.js"></script>
        <link rel="stylesheet" type="text/css" href="style/style.css"></link>
    </head>    
    
    <!--
    File Input/Drondeploy API functions (JSON Parsing functions below):
    parseFile
    updatePlan
    to handle shp/zip import and create a Dronedeploy plan
    -->
    <script>
        var utm = "+proj=utm +zone=32";
        var wgs84 = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";
        /*
        Title: parseFile(files)
        Author: Adhiraj Datar
        Parameters List of Files contained in current input object
        Function: Reads the file held by the file input object and generates
        and arraybuffer that can be passed into a the library to turn shp and zip
        files into geojson objects. 
        */
        function parseFile(files) {
            var currentFile = files[0];
            var fileType = getFileType(currentFile);
            var reader = new FileReader();
            reader.onload = function() {            
                var arrayBuffer = reader.result;

                if (fileType === "shp") {
                    var geojson = shp.parseShp(arrayBuffer);
                    alert("Starting plan generation for: "+currentFile.name);
                    parseGeometryJson(geojson, currentFile.name);
                }else if (fileType === "zip") {
                    var geojson = shp(arrayBuffer).then(function (geojson) {
                        alert("Starting plan generation for: "+currentFile.name);
                        parseFeatureJson(geojson, currentFile.name);
                    });
                }else {
                    alert("Unsupported File Type: Please input only .shp and .zip Files");   
                }
            }
            reader.readAsArrayBuffer(currentFile);
        }

        /*
        Title: updatePlan(coordinates, fileName)
        Author: Adhiraj Datar
        Parameters: coordinates of the shape file entered into this application
        Function: Calls the Dronedeploy api to update the current plan with
        the given co-ordinates and input file name. 
        */        
        function updatePlan(coordinates, fileName) {
            console.log(JSON.stringify(coordinates));
            new DroneDeploy({version: 1}).then(function(api){
                api.Plans.getCurrentlyViewed().then(function(plan){
                    api.Plans.update(plan.id, {
                        name: fileName,
                        geometry: coordinates
                    });            
                    alert("Your update has been queued. Please wait");
                });
            });              
        }

        function getFileType(file) {
            return ((file.name).substr((file.name).length - 3));
        }    
    </script>
    
    <!--Create File Input UI-->
    <div class="wrapper">
        <div class="title">
            <u>Convert Shp/Zip to Plan</u>
        </div>
        <div class="image-upload">
            <div class="instructions" style="">
                Choose a File:
            </div>
            <label class="input-label" for="file-input">
                <img src="img/upload.png"/>
            </label>

            <input id="file-input" type="file" onchange="parseFile(this.files)"/>         
        </div>
    </div>

    <!--
    JSON Parsing Functions (File IO/Dronedeploy api functions below):
    parseGeometryJson
    parseFeatureJson
    to handle shp/zip import and create a Dronedeploy plan
    -->
    <script>
        /*
        Title: parseGeometryJson(geojson, fileName)
        Author: Adhiraj Datar
        Parameters: geojson generated by Calvinmetcalf's shp library for
        an Geometry input. Geometries have different JSON structures than Features
        Function: Parses the JSON returned by an shp(file) call and obtains the
        coordinates that define this shape file and which can be used to generate
        the Dronedeploy plan.
        */
        function parseGeometryJson(geojson, fileName) {
            var planCoordinates = [];
            
            //process geometry shape by shape to retrieve coordinates to add to plan
            for(geometry in geojson) {
                var currentGeometry = geojson[geometry];
                for(shape in currentGeometry.coordinates) {
                    var geometryCoordinates = currentGeometry.coordinates[shape];
                    if (currentGeometry.type === "LineString" || currentGeometry.type === "Point") {
                        //If geojson is encoded in Easting and Northing they need to be converted to Lat/Lon
                        if(Math.abs(geometryCoordinates[0]) > 180 || Math.abs(geometryCoordinates[1]) > 90) {
                            var latlon = proj4(utm,wgs84,[geometryCoordinates[0], geometryCoordinates[1]])
                            planCoordinates.push({
                                lat:latlon[0],
                                lng:latlon[1]
                            });                           
                        }else {
                            planCoordinates.push({
                                lat:geometryCoordinates[1],
                                lng:geometryCoordinates[0]
                            });                            
                        }
                    }else if (currentGeometry.type === "Polygon") {
                        for(coordinate in geometryCoordinates) {
                            var currentCoordinates = geometryCoordinates[coordinate];
                            //If geojson is encoded in Easting and Northing they need to be converted to Lat/Lon
                            if(Math.abs(currentCoordinates[0]) > 180 || Math.abs(currentCoordinates[1]) > 90) {
                                var latlon = proj4(utm,wgs84,[currentCoordinates[0], currentCoordinates[1]])
                                planCoordinates.push({
                                    lat:latlon[0],
                                    lng:latlon[1]
                                });                           
                            }else {
                                planCoordinates.push({
                                    lat:currentCoordinates[1],
                                    lng:currentCoordinates[0]
                                });                           
                            }
                        }                        
                    }
                } 
            }
            updatePlan(planCoordinates, fileName);
        }

        /*
        Title: parseZipJson(geojson, fileName)
        Author: Adhiraj Datar
        Parameters: geojson generated by Calvinmetcalf's shp library for
        a feature input. Features have different JSON structures than Geometries.
        Function: Parses the JSON returned by an shp.parseZip(buffer) call and obtains the
        coordinates that define this shape file and which can be used to generate
        the Dronedeploy plan.
        */        
        function parseFeatureJson(geojson, fileName) {
            var planCoordinates = [];
            
            for (feature in geojson.features) {
                var currentFeature = geojson.features[feature];
                
                //retrieve current geometry from the feature
                var currentGeometry = currentFeature.geometry;
                
                //process geometry shape by shape and retrieve coordinates to add to plan
                for(shape in currentGeometry.coordinates) {
                    var geometryCoordinates = currentGeometry.coordinates[shape];
                    if (currentGeometry.type === "LineString") {
                        //If geojson is encoded in Easting and Northing they need to be converted to Lat/Lon
                        if(Math.abs(geometryCoordinates[0]) > 180 || Math.abs(geometryCoordinates[1]) > 90) {
                            var latlon = proj4(utm,wgs84,[geometryCoordinates[0], geometryCoordinates[1]])
                            planCoordinates.push({
                                lat:latlon[0],
                                lng:latlon[1]
                            });                           
                        }else {
                            planCoordinates.push({
                                lat:geometryCoordinates[1],
                                lng:geometryCoordinates[0]
                            });                            
                        }
                    }else if (currentGeometry.type === "Polygon") {
                        for(coordinate in geometryCoordinates) {
                            var currentCoordinates = geometryCoordinates[coordinate];
                            //If geojson is encoded in Easting and Northing they need to be converted to Lat/Lon
                            if(Math.abs(currentCoordinates[0]) > 180 || Math.abs(currentCoordinates[1]) > 90) {
                                var latlon = proj4(utm,wgs84,[currentCoordinates[0], currentCoordinates[1]])
                                planCoordinates.push({
                                    lat:latlon[0],
                                    lng:latlon[1]
                                });                           
                            }else {
                                planCoordinates.push({
                                    lat:currentCoordinates[1],
                                    lng:currentCoordinates[0]
                                });                           
                            }                        
                        }                        
                    }
                }
            }
            updatePlan(planCoordinates, fileName);
        }
    </script>
    
</html>